{if $action == 'lister' || $action == 'debit' || $action == 'credit' }

<!-- Required for paybox popups -->
<meta name="referrer" content="no-referrer" />

    <h2>Liste journal {$action} </h2>

   <img src="{$chemin_template}images/puce.png" class="puce" alt="Puce" /><a href="index.php?page=compta_journal&amp;action=ajouter" title="ajouter une écriture">Ajouter une écriture</a><br />
   <img src="{$chemin_template}images/puce.png" class="puce" alt="Puce" /><a href="index.php?page=compta_journal&amp;action=importer" title="importer un fichier csv">Importer un fichier CSV</a><br />
<br>
    <img src="{$chemin_template}images/puce.png" class="puce" alt="Puce" /><a href="index.php?page=compta_journal&amp;action=lister&id_periode={$smarty.get.id_periode}" title="ajouter une écriture">Journal Dépenses/Recettes</a><br />
   <img src="{$chemin_template}images/puce.png" class="puce" alt="Puce" /><a href="index.php?page=compta_journal&amp;action=debit&id_periode={$smarty.get.id_periode}" title="ajouter une écriture">Journal des dépenses</a><br />
    <img src="{$chemin_template}images/puce.png" class="puce" alt="Puce" /><a href="index.php?page=compta_journal&amp;action=credit&id_periode={$smarty.get.id_periode}" title="ajouter une écriture">journal des recettes</a><br />
      <br/>

  <table>
    <form method="GET" name="forum">
      <input type="hidden" name="page" value="compta_journal" />
     <h2>Année comptable <select name="id_periode" onchange="this.form.submit(); return false;">
    {foreach from=$listPeriode item=periode}
    <option value="{$periode.id}"{if $id_periode == $periode.id} selected{/if}>{$periode.date_debut} - {$periode.date_fin}</option>
    {/foreach}
    </select></h2>
    </form>
    </table>
    <br/>
    <table class="afup_tab">
        <tr>
            <!-- th width="20px">&nbsp;</th -->
           <th><a href="index.php?page=compta_journal&amp;tri=date_consultation&amp;sens={if $smarty.get.sens == 'asc' && $smarty.get.tri == 'date_consultation'}desc{else}asc{/if}">Date</a></th>
            <th>Compte</th>
           <th><a href="index.php?page=compta_journal&amp;tri=evenement&amp;sens={if $smarty.get.sens == 'asc' && $smarty.get.tri == 'date_consultation'}desc{else}asc{/if}">Evenement</a></th>
           <th><a href="index.php?page=compta_journal&amp;tri=categorie&amp;sens={if $smarty.get.sens == 'asc' && $smarty.get.tri == 'date_consultation'}desc{else}asc{/if}">Catégorie</a></th>
            <th>Description</th>
            <th>Debit</th>
            <th>Crédit</th>
            <th>Reglement</th>
            <th>&nbsp;</th>
       </tr>
    {foreach from=$journal item=ecriture}
         <tr class="{cycle values="odd,even"}">
            <!-- td width="20px"><input type="checkbox" value=""/></td -->
            <td nowrap="nowrap"><a name="L{$ecriture.idtmp}"></a>{$ecriture.date_ecriture|date_format:"%d/%m/%Y"}</td>
            <td>{$ecriture.nom_compte}</td>
            <td>
            {if $ecriture.evenement=='A déterminer'}
                <select class="js-select-change" data-post-url="index.php?page=compta_journal&amp;action=modifier_colonne&amp;column=evenement&amp;id={$ecriture.idtmp}" style="width: 130px">
                    {foreach from=$events item=event_name key=event_id}
                    <option value="{$event_id}">{$event_name}</option>
                    {/foreach}
                </select>
            {else}
                {$ecriture.evenement}
            {/if}
            </td>
             <td>
                {if $ecriture.categorie=='A déterminer'}
                <select class="js-select-change" data-post-url="index.php?page=compta_journal&amp;action=modifier_colonne&amp;column=categorie&amp;id={$ecriture.idtmp}" style="width: 130px">
                    {foreach from=$categories item=cat_name key=cat_id}
                    <option value="{$cat_id}">{$cat_name}</option>
                    {/foreach}
                </select>
                {else}
                    {$ecriture.categorie}
                {/if}
             </td>
             <td  width="250">
                 {$ecriture.description|paybox_link}
             </td>
		{if $ecriture.idoperation == 1}
			<td  align='right' width='100'>-{$ecriture.montant|number_format:2:',':' '}</td>
			<td width='100'></td>
		{else}
			<td width='100'></td>
			<td align='right' width='100'>+{$ecriture.montant|number_format:2:',':' '}</td>
		{/if}

            <td>
            {if $ecriture.reglement=='A déterminer'}
                <select class="js-select-change" data-post-url="index.php?page=compta_journal&amp;action=modifier_colonne&amp;column=reglement&amp;id={$ecriture.idtmp}">
                    {foreach from=$payment_methods item=method_name key=method_id}
                    <option value="{$method_id}">{$method_name}</option>
                    {/foreach}
                </select>
            {else}
                {$ecriture.reglement}
            {/if}
            </td>
            <td style="text-align: right">

                <a class="js-edit-comment" style="cursor:pointer;"
                   data-post-url="index.php?page=compta_journal&amp;action=modifier_colonne&amp;column=comment&amp;id={$ecriture.idtmp}"
                   data-comment="{$ecriture.comment}"><img src="{$chemin_template}images/famfamfam/comment_{if $ecriture.comment}edit{else}add{/if}.png"
                         data-img-src-edit="{$chemin_template}images/famfamfam/comment_edit.png"
                         data-img-src-add="{$chemin_template}images/famfamfam/comment_add.png"
                         alt="Editer le commentaire" /></a>

                <a href="index.php?page=compta_journal&amp;action=modifier&amp;id={$ecriture.idtmp}" title="Modifier la ligne {$ecriture.description}"><img src="{$chemin_template}images/famfamfam/application_form_edit.png" alt="Modifier" /></a>
                <a href="#" title="Ventiler la fiche de {$ecriture.description} " onclick="javascript:ventiler({$ecriture.idtmp}, {$ecriture.montant});return false;"><img src="{$chemin_template}images/famfamfam/arrow_divide.png" alt="Ventiler" /></a>
                <a href="index.php?page=compta_journal&amp;action=supprimer&amp;id={$ecriture.idtmp}" title="Supprimer la fiche de {$ecriture.description} " onclick="return confirm('Etes-vous sûr de vouloir supprimer la fiche de {$ecriture.description} ?');"><img src="{$chemin_template}images/famfamfam/delete.png" alt="Supprimer" /></a>
               </td>
        </tr>
    {foreachelse}
        <tr>
            <td><em>Aucune ecriture actuellement</em></td>
        </tr>
    {/foreach}
     </table>

    {literal}
    <script>
        // Ventiler une ligne
        function ventiler(idLigne, montant) {
            ventilation = prompt('Combien souhaitez-vous ventiler ?', montant);
            if (ventilation) {
                if (ventilation >= montant) {
                    alert('Vous ne pouvez pas saisir une valeur égale ou supérieur à la valeur initiale !')
                } else {
                    window.location='index.php?page=compta_journal&action=ventiler&id=' + idLigne + '&montant=' + ventilation;
                }
            }
        }

        // Paybox link in popup
        (function ($) {
            $(document).ready(function () {
                $('.js-paybox-link').click(function () {
                    var url = $(this).attr('href');
                    window.open(url, "paybox", "width=1100, height=650");
                    return false;
                });
            });
        })(jQuery);

        // Update line column value using select
        // Or update comment using simple link and dialog box
        (function ($) {
            $(document).ready(function () {
                // When we change the value of a select
                $('.js-select-change').change(function (e) {
                    var elmt = $(e.target);

                    // Process request to change the column
                    $.ajax({
                        url: elmt.data('post-url'),
                        type: 'post',
                        data: {
                            val: elmt.val()
                        },
                        dataType: 'json',
                        success: function (data, textStatus, jqXHR) {
                            // remove all span in td
                            elmt.parent().find('span').remove();

                            // update td content
                            var span = $('<span></span>');
                            span.html(elmt.find('option:selected').html() + " &#x2705;"); // success emoji: &#x2705;
                            elmt.parent().append(span);
                            elmt.remove();
                        },
                        error: function (data, textStatus, jqXHR) {
                            // remove all span in td
                            elmt.parent().find('span').remove();

                            // update td content
                            var span = $('<span></span>');
                            span.html(" &#x1F6AB;"); // error emoji: &#x1F6AB;
                            elmt.parent().append(span);
                            elmt.val("");
                        }
                    });
                });

                // When we click on the comment link
                $('a.js-edit-comment').click(function (e) {
                    e.stopPropagation(); // Stop here

                    if (e.target.nodeName === "IMG") {
                        var elmt = $(e.target).parent();
                    } else {
                        var elmt = $(e.target);
                    }

                    // Get comment
                    var comment = prompt("Commentaire :", elmt.data('comment'));

                    // We have a comment, so update it!
                    if (comment !== null) {
                        $.ajax({
                            url: elmt.data('post-url'),
                            type: 'post',
                            data: {
                                val: comment
                            },
                            dataType: 'json',
                            success: function (/* data, textStatus, jqXHR */) {
                                // Update image
                                var img = elmt.find('img');
                                if (comment.length) {
                                    var src = img.data('img-src-edit');
                                } else {
                                    var src = img.data('img-src-add');
                                }
                                img.attr('src', src);

                                // Update comment in element's data
                                elmt.data('comment', comment);
                            },
                            error: function (/* data, textStatus, jqXHR */) {
                                alert('oops… something went wrong');
                            }
                        });
                    }

                    return false;
                });
            });
        })(jQuery);
    </script>
    {/literal}

{else}
    {if $action == 'importer'}
        <h2>Importer un fichier</h2>
    {elseif $action == 'ajouter'}
        <h2>Ajouter une écriture (facture)</h2>
    {else}
        <h2>Modifier une écriture (facture)</h2>
    {/if}
    {include file="formulaire.html"}
{/if}